<!doctype html>
<html lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="color-scheme" content="light dark">
    <title>GA/TAS Server</title>

    <link rel="stylesheet" href="css/styles.scss"/>
</head>

<body id="body" class="overflow-x-hidden">
<script>
    if (window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches) {
        document.body.classList.add("dark");
    }
</script>

<main class="container">
    <gatasserver-main></gatasserver-main>
</main>

</body>

<script type="module">
    import {El} from "@frameable/el"
    import store from "./components/store";
    import "./components/buttonloader";
    import "./components/aircraft"

    const isOpenClass = "modal-is-open";
    const openingClass = "modal-is-opening";
    const closingClass = "modal-is-closing";
    const animationDuration = 400;

    class GaTasMain extends El {

        created() {
            this.state = this.$observable({
                loading: false,
                showAlert: false,
                alertText: ''
            });
        }

        _isNumeric(str) {
            if (typeof str != "string") return false // we only process strings!
            return !isNaN(str) && // use type coercion to parse the _entirety_ of the string (`parseFloat` alone does not do this)...
                !isNaN(parseFloat(str)) // ...and ensure strings of whitespace fail
        }

        _byPin() {

            const pin = this.$refs.gatasId.value.trim();
            if (!pin) return;

            if (!this._isNumeric(pin)) {
                this._showAlert("Pin code must be a numeric value between 1000 and 999999.");
                return
            }

            if (!("geolocation" in navigator)) {
                this._showAlert("Geolocation is not supported by this browser.");
                return;
            }
            this.state.loading = true;
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const userLatitude = position.coords.latitude;
                    const userLongitude = position.coords.longitude;
                    store.getGatasIdByPin(userLatitude, userLongitude, Number(pin))
                        .then((gatasId) => {
                            const gatasIdHex = gatasId.toString(16).toUpperCase()
                            this.$refs.gatasId.value = gatasIdHex
                            window.location.hash = encodeURIComponent(gatasIdHex);
                            return store.init(gatasId);
                        })
                        .catch(err => {
                            store.clear();
                            this._showAlert("Failed to resolve GA/TAS ID from pin.");
                        })
                        .finally(() => {
                            this.state.loading = false;
                        });
                },
                (error) => {
                    store.clear();
                    this.state.loading = false;
                    switch (error.code) {
                        case error.PERMISSION_DENIED:
                            this._showAlert("Location permission denied. Please enable location permissions to enable this functionality.");
                            break;
                        case error.POSITION_UNAVAILABLE:
                            this._showAlert("Location information is unavailable.");
                            break;
                        case error.TIMEOUT:
                            this._showAlert("Request timed out to GA/TAS Connect.");
                            break;
                        default:
                            this._showAlert("Unknown error, please try again");
                    }
                },
                {
                    enableHighAccuracy: true,
                    timeout: 5_000,
                    maximumAge: 0
                }
            );
        }

        _byId() {
            const gatasId = this.$refs.gatasId.value.trim();
            if (!gatasId) return;

            // update state and set hash
            window.location.hash = encodeURIComponent(gatasId);
            this.state.loading = true;
            store.init(parseInt(gatasId, 16))
                .catch((e) => {
                    this._showAlert("Error communicating with gatas Connect");
                    store.clear();
                })
                .finally(() => {
                    this.state.loading = false;
                });
        }

        _showAlert(text) {
            this.state.alertText = text;
            this.state.showAlert = true;
        }

        mounted() {
            setTimeout(() => {
                const gatasId = window.location.hash.substring(1);
                if (gatasId && gatasId.length > 0) {
                    store.init(parseInt(parseInt(window.location.hash.substring(1), 16)));
                    this.$refs.gatasId.value = store.state.gatasId.toString(16).toUpperCase();
                }
            }, 50);
        }


        _selected(mode_s) {
            store.changeAircraft(mode_s);
            if (this.onselect) {
                this.onselect(mode_s)
            }
        }

        alert(html) {
            return html`
                <dialog id="modal-example" ref="alertModal" ${this.state.showAlert ? 'open' : ''}>
                    <article>
                        <header>
                            <button
                                    aria-label="Close"
                                    rel="prev"
                                    data-target="modal-example"
                                    onclick=${() => this.state.showAlert = false}
                            ></button>
                            <h3>Error</h3>
                        </header>
                        <p>
                            ${this.state.alertText}
                        </p>
                        <footer>
                            <button autoFocus data-target="modal-example" onclick=${() => this.state.showAlert = false}>
                                Close
                            </button>
                        </footer>
                    </article>
                </dialog>`;
        }

        render(html) {
            return this.alert(html) + html`
                <input name="gatasId" ref="gatasId" type="gatasId" placeholder="GA/TAS ID or pinCode" autocomplete=""/>
                <div class="buttons">
                    <div>
                        <button-loader key="btnById" loading="${this.state.loading}" onclick=${this._byId}>Find by ID
                        </button-loader>
                    </div>
                    <div>
                        <button-loader key="btnByPin" loading="${this.state.loading}" onclick=${this._byPin}>Find by pin
                            code
                        </button-loader>
                    </div>
                </div>

                <article>
                    <small>
                        <strong>GA/TAS IP:</strong>
                        ${store.state.gatasIp
                                ? html`<a href="http://${store.state.gatasIp}" target="_blank">
                                    ${store.state.gatasIp}
                                </a>`
                                : html`not found`}
                    </small>
                </article>

                <div class="button-container">
                    ${store.state.icaoAddressList.map(item => html`
                        <aircraft-config key=${item} modes=${item}
                                         onclick=${() => this._selected(item)}></aircraft-config>
                    `)}
                </div>
            `;
        }
    }

    customElements.define("gatasserver-main", GaTasMain);
</script>

</html>
